<%- include("../partials/homepage/userHeader") %>

<style>
    .custom-logout-btn {
        background-color: rgb(220, 49, 49);
        border-color: brown;
    }
    .custom-logout-btn:hover {
        background-color: rgb(200, 40, 40); /* Change to desired hover color */
        border-color: brown;
    }
</style>

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="/home" rel="nofollow">Home</a>
                <span></span> Pages
                <span></span> Account
            </div>
        </div>
    </div>
    <section class="pt-150 pb-150">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 m-auto">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="dashboard-menu">
                                <ul class="nav flex-column" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false"><i class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false"><i class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false"><i class="fi-rs-shopping-cart-check mr-10"></i>Track Your Order</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true"><i class="fi-rs-marker mr-10"></i>My Address</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab" href="#account-detail" role="tab" aria-controls="account-detail" aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                    </li>
                                    <li class="nav-item">
                                        <a id="logout"  class="nav-link" href="/logout"><i class="fi-rs-sign-out mr-10"></i>Logout</a>
                                    </li>
                                    <!-- modal starting -->
                                    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="logoutModalLabel">Confirm Logout</h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    Are you sure you want to logout?
                                                </div>
                                                <div class="modal-footer">
                                                    <a href="/account">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                    </a>
                                                    
                                                    <button id="confirmLogout" type="button" class="btn btn-primary">Logout</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- modal ending -->

                                </ul>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="tab-content dashboard-content">
                                <div class="tab-pane fade active show" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            
                                            <% if (req.session.user_id) { %>
                                            <span> <h5 class="mb-0">hello, <%= req.session.userName %></h5></span>
                                            <% } %>
                                        
                                        </div>
                                        
                                        <div class="card-body">
                                            <p>From your account dashboard. you can easily check &amp; view your <a href="#">recent orders</a>, manage your <a href="#">shipping and billing addresses</a> and <a href="#">edit your password and account details.</a></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Your Orders</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                
                                                <table class="table">
                                                    <thead> 
                                                    
                                                    
                                                        <tr>
                                                            <th>Order</th>
                                                            <th>Date</th>
                                                            <th>Status</th>
                                                            <th>Total</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <% if (orderData && orderData.length > 0) { %>
                                                        <% orderData.forEach(order => { %>
                                                    <tbody>
                                                        <tr>
                                                            <td>#<%= order.orderId %></td>
                                                            <td><%= order.createdAt.toLocaleDateString() %></td>
                                                            <td><%= order.orderStatus %></td>
                                                            <td>$<%= order.billTotal.toFixed(2) %></td>
                                                            <td><a href="/order-confirmation?orderId=<%= order.orderId %>" class="btn-small d-block">View</a></td>
                                                        </tr>
                                                        
                                                        
                                                    </tbody>
                                                    <% }); %>
                                                <% } else { %>
                                                    <p>No orders found.</p>
                                                <% } %>
                                                    
                                                </table>
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Orders tracking</h5>
                                        </div>
                                        <div class="card-body contact-from-area">
                                            <p>To track your order please enter your OrderID in the box below and press "Track" button. This was given to you on your receipt and in the confirmation email you should have received.</p>
                                            <div class="row">
                                                <div class="col-lg-8">
                                                    <form class="contact-form-style mt-30 mb-50" action="#" method="post">
                                                        <div class="input-style mb-20">
                                                            <label>Order ID</label>
                                                            <input name="order-id" placeholder="Found in your order confirmation email" type="text" class="square">
                                                        </div>
                                                        <div class="input-style mb-20">
                                                            <label>Billing email</label>
                                                            <input name="billing-email" placeholder="Email you used during checkout" type="email" class="square">
                                                        </div>
                                                        <button class="submit submit-auto-width" type="submit">Track</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                    <div class="row">
                                        <% addressData.forEach(address => { %>
                                        <div class="col-lg-6">
                                            
                                            <div class="card mb-3 mb-lg-0">
                                                <div class="card-header">
                                                    <h5 class="mb-0"><%= address.addressType %></h5>
                                                </div>
                                                <div class="card-body">
                                                    <address><%= address.addressLine1 %><br><%= address.addressLine2 %><br><%= address.city %><br><%= address.state %>,<br> <%= address.zipCode %></address>
                                                    <p>INDIA</p>
                                                    <a href="#" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editAddressModal" data-addressid="<%= address._id %>" data-addresstype="<%= address.addressType %>" data-addressline1="<%= address.addressLine1 %>" data-addressline2="<%= address.addressLine2 %>" data-city="<%= address.city %>" data-state="<%= address.state %>" data-zipcode="<%= address.zipCode %>">Edit</a>
            <button                                 class="btn btn-google btn-sm" onclick="deleteAddress('<%= address._id %>')">Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                        <% }) %>
                                        <!-- Edit Address Modal -->
                                                <div class="modal fade" id="editAddressModal" tabindex="-1" role="dialog" aria-labelledby="editAddressModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                    <span aria-hidden="true">&times;</span>
                                                                </button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <form>
                                                                    <div class="form-group">
                                                                        <label for="editAddressType">Address Type</label>
                                                                        <select class="form-control" id="editAddressType">
                                                                            <option value="home">Home</option>
                                                                            <option value="office">Office</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label for="editAddressLine1">Address Line 1</label>
                                                                        <input type="text" class="form-control" id="editAddressLine1" placeholder="Enter address line 1">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label for="editAddressLine2">Address Line 2</label>
                                                                        <input type="text" class="form-control" id="editAddressLine2" placeholder="Enter address line 2">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label for="editCity">City</label>
                                                                        <input type="text" class="form-control" id="editCity" placeholder="Enter city">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label for="editState">State</label>
                                                                        <input type="text" class="form-control" id="editState" placeholder="Enter state">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label for="editZipCode">Zip Code</label>
                                                                        <input type="text" class="form-control" id="editZipCode" placeholder="Enter zip code">
                                                                    </div>
                                                                </form>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                                <button type="button" class="btn btn-primary" id="updateAddressBtn">Update Address</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- end -->
                                        <!--add modal start -->
                                        <div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form>
                                                            <div class="form-group">
                                                                <label for="addressType">Address Type</label>
                                                                <select class="form-control" id="addressType">
                                                                    <option value="home">Home</option>
                                                                    <option value="office">Office</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="addressLine1">Address Line 1</label>
                                                                <input type="text" class="form-control" id="addressLine1" placeholder="Enter address line 1">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="addressLine2">Address Line 2</label>
                                                                <input type="text" class="form-control" id="addressLine2" placeholder="Enter address line 2">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="city">City</label>
                                                                <input type="text" class="form-control" id="city" placeholder="Enter city">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="state">State</label>
                                                                <input type="text" class="form-control" id="state" placeholder="Enter state">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="zipCode">Zip Code</label>
                                                                <input type="text" class="form-control" id="zipCode" placeholder="Enter zip code">
                                                            </div>
                                                        </form>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                        <button type="button" class="btn btn-primary" id="saveAddressBtn">Save Address</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--add modal ending -->
                                        <!-- button -->
                                        <div class="row">
                                            <!-- Billing Address and Shipping Address cards -->
                                        
                                            <div class="col-12 mt-3">
                                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addAddressModal">
                                                    Add Address
                                                </button>
                                            </div>
                                        </div>
                                        <!-- button  -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>Account Details</h5>
                                        </div>
                                        <div class="card-body">
                                            <!-- <p>Already have an account? <a href="/register">Log in instead!</a></p> -->
                                            <form method="post" name="enq" action="/update-profile">
                                                <div class="row">
                                                                  
                                                    
                                                    <div class="form-group col-md-12">
                                                        <label>Display Name <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="dname" value="<%=userData.name%>" type="text">
                                                    </div>
                                                    <div class="form-group col-md-12">
                                                        <label>Email Address <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="email" value="<%=userData.email%>" type="email" readonly>
                                                    </div>
                                                     <div class="form-group col-md-12">
                                                        <label>Number <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="number" value="<%=userData.mobile%>" type="number">
                                                    </div>
                                                    <!--<div class="form-group col-md-12">
                                                        <label>New Password <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="npassword" type="password">
                                                    </div>
                                                    <div class="form-group col-md-12">
                                                        <label>Confirm Password <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="cpassword" type="password">
                                                    </div> -->
                                                    <div class="col-md-12">
                                                        <button type="submit" class="btn btn-fill-out submit" name="submit" value="Submit">Save</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    


    <script>
        // JavaScript to handle logout
        document.getElementById('logout').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default link action
            $('#logoutModal').modal('show'); // Show the modal
        });

        document.getElementById('confirmLogout').addEventListener('click', function(event) {
            event.preventDefault();
            window.location.href = '/logout'; // Redirect to logout URL
        });

        const saveAddressBtn = document.getElementById('saveAddressBtn');

    saveAddressBtn.addEventListener('click', function() {
        const addressType = document.getElementById('addressType').value;
        const addressLine1 = document.getElementById('addressLine1').value;
        const addressLine2 = document.getElementById('addressLine2').value;
        const city = document.getElementById('city').value;
        const state = document.getElementById('state').value;
        const zipCode = document.getElementById('zipCode').value;

        console.log(addressType,addressLine1,addressLine2,city,state,zipCode)
        // Here, you can send the address data to the server using AJAX or form submission
        // For example, using AJAX:
        fetch('/save-address', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                addressType,
                addressLine1,
                addressLine2,
                city,
                state,
                zipCode,
            }),
        })
        .then(response => {
            if (response.ok) {
                // Address added successfully
                // alert('Address added successfully');
                // res.redirect('/account')
                window.location.href='/account'
                alert('Address added successfully');
                // You can update the UI or perform any other necessary actions
                $('#addAddressModal').modal('hide');
            } else {
                // Handle error
                alert('Failed to add address');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the address');
        });
    });

    // JavaScript to handle the edit address modal
    $('#editAddressModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Button that triggered the modal
        var addressId = button.data('addressid'); // Extract info from data-* attributes
        var addressType = button.data('addresstype');
        var addressLine1 = button.data('addressline1');
        var addressLine2 = button.data('addressline2');
        var city = button.data('city');
        var state = button.data('state');
        var zipCode = button.data('zipcode');

        // Update the modal's input fields with the address data
        var modal = $(this);
        modal.find('#editAddressType').val(addressType);
        modal.find('#editAddressLine1').val(addressLine1);
        modal.find('#editAddressLine2').val(addressLine2);
        modal.find('#editCity').val(city);
        modal.find('#editState').val(state);
        modal.find('#editZipCode').val(zipCode);

        // Add click event listener to the update button
        modal.find('#updateAddressBtn').off('click').on('click', function() {
            var updatedAddressType = modal.find('#editAddressType').val();
            var updatedAddressLine1 = modal.find('#editAddressLine1').val();
            var updatedAddressLine2 = modal.find('#editAddressLine2').val();
            var updatedCity = modal.find('#editCity').val();
            var updatedState = modal.find('#editState').val();
            var updatedZipCode = modal.find('#editZipCode').val();

            // Send the updated address data to the server using AJAX
            fetch(`/update-address/${addressId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    addressType: updatedAddressType,
                    addressLine1: updatedAddressLine1,
                    addressLine2: updatedAddressLine2,
                    city: updatedCity,
                    state: updatedState,
                    zipCode: updatedZipCode,
                }),
            })
            .then(response => {
                if (response.ok) {
                    // Address updated successfully
                    alert('Address updated successfully');
                    // You can perform any other necessary actions
                    $('#editAddressModal').modal('hide');
                    location.reload(); // Reload the page to reflect the changes
                } else {
                    // Handle error
                    alert('Failed to update address');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the address');
            });
        });
    });

    // JavaScript to handle the delete address functionality
    function deleteAddress(addressId) {
        if (confirm('Are you sure you want to delete this address?')) {
            fetch(`/delete-address/${addressId}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    // Address deleted successfully
                    alert('Address deleted successfully');
                    location.reload(); // Reload the page to reflect the changes
                } else {
                    // Handle error
                    alert('Failed to delete address');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the address');
            });
        }
    }
    </script>

<%- include("../partials/homepage/userFooter") %>