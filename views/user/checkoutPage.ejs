<%- include("../partials/homepage/userHeader") %>

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html" rel="nofollow">Home</a>
                <span></span> Shop
                <span></span> Checkout
            </div>
        </div>
    </div>
    <section class="mt-50 mb-50">
        <div class="container">
            <!-- <div class="row">
                
                <div class="col-lg-6">
                    <div class="toggle_info">
                        <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a href="#coupon" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to enter your code</a></span>
                    </div>
                    <div class="panel-collapse collapse coupon_form " id="coupon">
                        <div class="panel-body">
                            <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                            <form method="post">
                                <div class="form-group">
                                    <input type="text" placeholder="Enter Coupon Code...">
                                </div>
                                <div class="form-group">
                                    <button class="btn  btn-md" name="login">Apply Coupon</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div> -->
            <div class="row">
                <div class="col-12">
                    <div class="divider mt-20 mb-20"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-25">
                        <h4>Billing Details</h4>
                    </div>
                    <div class="card mb-3 mb-lg-0">

                        <div class="card-header">
                            <h5>Select Address</h5>                        
                        </div>
                        
                        <div class="card-body">
                            <% addressData.forEach(address => { %>
                            <div class="col-lg-6 pb-20">
                                
                                <div class="card mb-3 mb-lg-0">
                                    <div class="card-header">
                                        <div class="custome-radio">
                                            <input class="form-check-input" type="radio" name="selectedAddress" id="address<%= address._id %>" value="<%= address._id %>">
                                            <label class="form-check-label" for="address<%= address._id %>">
                                                <h5 class="mb-0"><%= address.addressType %></h5>

                                            </label>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <address><%= address.addressLine1 %>, <%= address.addressLine2 %><br><%= address.city %>, <%= address.state %><br> <%= address.zipCode %></address>
                                    </div>
                                </div>
                            </div>
                            <% }) %>
                        </div>
                    </div>
                    <form method="post">
                        
                        <div class="ship_detail">
                            <div class="form-group">
                                <div class="chek-form">
                                    <div class="custome-checkbox">
                                        <input class="form-check-input" type="checkbox" name="checkbox" id="differentaddress">
                                        <label class="form-check-label label_info" data-bs-toggle="collapse" data-target="#collapseAddress" href="#collapseAddress" aria-controls="collapseAddress" for="differentaddress"><span>Ship to a different address?</span></label>
                                    </div>
                                </div>
                            </div>
                            <div id="collapseAddress" class="different_address collapse in">
                                
                                <div class="form-group">
                                    <label for="addressType">Address Type</label>
                                    <select class="form-control" id="addressType">
                                        <option value="home">Home</option>
                                        <option value="office">Office</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="addressLine1">Address Line 1</label>
                                    <input type="text" class="form-control" id="addressLine1" placeholder="Enter address line 1">
                                </div>
                                <div class="form-group">
                                    <label for="addressLine2">Address Line 2</label>
                                    <input type="text" class="form-control" id="addressLine2" placeholder="Enter address line 2">
                                </div>
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" class="form-control" id="city" placeholder="Enter city">
                                </div>
                                <div class="form-group">
                                    <label for="state">State</label>
                                    <input type="text" class="form-control" id="state" placeholder="Enter state">
                                </div>
                                <div class="form-group">
                                    <label for="zipCode">Zip Code</label>
                                    <input type="text" class="form-control" id="zipCode" placeholder="Enter zip code">
                                </div>
                            </div>
                            
                        </div>
                    </form>
                        <div class="col-lg-6">
                            <div class="toggle_info">
                                <span><i class="fi-rs-label mr-10"></i><span data-toggle="modal" data-target="#couponModal" class="text-muted">Have a coupon?</span> <a href="#couponModal" data-bs-toggle="modal" class="collapsed" aria-expanded="false">Click here to enter your code</a></span>
                                </div>
                                    <!-- modal coupon-->
                                    <div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="couponModalLabel">Coupon Code</h5>
                                                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-header">
                                                    <div class="ship_detail">
                                                        <div class="form-group">
                                                            <div class="chek-form">
                                                                <div class="custome-checkbox">
                                                                    <label class="form-check-label label_info" data-bs-toggle="collapse" data-target="#collapseCoupons" href="#collapseCoupons" aria-controls="collapseCoupons" for="coupons"><span>available Coupons</span></label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div id="collapseCoupons" class="coupon collapse in">
                                                            
                                                            <div class="form-group">
                                                                <div class="coupon-list overflow-auto" style="max-height: 300px; width: 450px;">
                                                                    <% for(let i=0; i<couponData.length; i++) { %>
                                                                        <% const isUsed = usedCoupons.includes(couponData[i].code); %>
                                                                        <div class="card mb-3 <%= isUsed ? 'bg-light' : '' %>">
                                                                            <div class="card-body">
                                                                                <h6 class="card-title <%= isUsed ? 'text-muted' : '' %>">
                                                                                    <%= couponData[i].code %> <%= isUsed ? '[Used]' : '' %>
                                                                                </h6>
                                                                                <p class="card-text"><%= couponData[i].description %></p>
                                                                                <small >
                                                                                    Discount: <%= couponData[i].discountPercentage %>%
                                                                                </small>
                                                                            </div>
                                                                        </div>
                                                                    <% } %>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                    </div>
                                                </div>
                                                <div class="modal-body">
                                                    <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                                                    
                                                        <div class="form-group">
                                                            <input id="couponCodeInput" type="text" placeholder="Enter Coupon Code...">
                                                        </div>
                                                        <div class="form-group">
                                                            <button onclick="applyCoupon()" class="btn btn-md" name="login">Apply Coupon</button>
                                                        </div>
                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <!-- modal coupon -->
                        </div>
                    
                </div>
                <div class="col-md-6">
                    <div class="order_review">
                        <div class="mb-20">
                            <h4>Your Orders</h4>
                        </div>
                        <div class="table-responsive order_table text-center">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th colspan="2">Product</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% cartData.items.forEach(item => { %>
                                    <tr>
                                        <td class="image product-thumbnail"><img src="/productImages/<%= item.productId.hoverImg %>" alt="#"></td>
                                        <td>
                                            <h5><a href="shop-product-full.html"><%= item.productId.name %></a></h5> <span class="product-qty">x <%= item.quantity %></span>
                                        </td>
                                        <td><%= item.subTotal %></td>
                                    </tr>
                                    <% }) %>
                                    
                                    <tr>
                                        <th>SubTotal</th>
                                        <td class="product-subtotal" colspan="2">$<%= cartData.total %></td>
                                    </tr>
                                    <tr>
                                        <th>Shipping</th>
                                        <td colspan="2"><em>Free Shipping</em></td>
                                    </tr>
                                    <tr>
                                        <th>discount</th>
                                        <td colspan="2"><em id="discount">0</em></td>
                                    </tr>
                                    <tr>
                                        <th>Total</th>
                                        <td colspan="2" class="product-subtotal font-xl text-brand fw-900">$<span class="font-xl text-brand fw-900" id="total"><%= cartData.total %></span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                        <div class="payment_method">
                            <div class="mb-25">
                                <h5>Payment</h5>
                            </div>
                            <div class="payment_option">
                                <div class="custome-radio">
                                    <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios3" value="COD" checked="">
                                    <label class="form-check-label" for="exampleRadios3" data-bs-toggle="collapse" data-target="#bankTranfer" aria-controls="bankTranfer">COD</label>
                                    <div class="form-group collapse in" id="bankTranfer">
                                        <p class="text-muted mt-5">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration. </p>
                                    </div>
                                </div>
                                <div class="custome-radio">
                                    <input class="form-check-input" required="" type="radio" name="payment_option" id="razorpayRadio" value="Razorpay">
                                    <label class="form-check-label" for="razorpayRadio">Razorpay</label>
                                </div>
                                <div class="custome-radio">
                                    <input class="form-check-input" required="" type="radio" name="payment_option" id="walletRadio" value="Wallet">
                                    <label class="form-check-label" for="walletRadio">Pay with Wallet</label>
                                </div>
                                <!-- <div class="custome-radio">
                                    <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios4" checked="">
                                    <label class="form-check-label" for="exampleRadios4" data-bs-toggle="collapse" data-target="#checkPayment" aria-controls="checkPayment">Check Payment</label>
                                    <div class="form-group collapse in" id="checkPayment">
                                        <p class="text-muted mt-5">Please send your cheque to Store Name, Store Street, Store Town, Store State / County, Store Postcode. </p>
                                    </div>
                                </div>
                                <div class="custome-radio">
                                    <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios5" checked="">
                                    <label class="form-check-label" for="exampleRadios5" data-bs-toggle="collapse" data-target="#paypal" aria-controls="paypal">Paypal</label>
                                    <div class="form-group collapse in" id="paypal">
                                        <p class="text-muted mt-5">Pay via PayPal; you can pay with your credit card if you don't have a PayPal account.</p>
                                    </div>
                                </div> -->
                            </div>
                        </div>
                        <a href="#" id="placeOrderBtn" class="btn btn-fill-out btn-block mt-30">Place Order</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<script>
    let appliedCouponId = null;
    let appliedCouponCode = null;
    let appliedDiscount = 0;
        async function applyCoupon() {
            alert('coupon applied')
            
            const couponCode = document.getElementById('couponCodeInput').value;
            alert(couponCode)
            let response = await fetch('/coupon-applied', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    couponCode
                })

                
            })
        const data = await response.json();
        console.log(data)
        if (data.success) {
            const total=document.getElementById("total").innerHTML
            document.getElementById('discount').innerHTML=data.discount

            let discountValue=parseInt(total)-parseInt(data.discount)
            document.getElementById("total").innerHTML=discountValue

            appliedCouponId = data.couponId;
            appliedCouponCode = couponCode;
            appliedDiscount = data.discount;
            Swal.fire('Success', 'Coupon applied successfully!', 'success');
        } else {
            Swal.fire('Error', data.message, 'error');
        }
        // document.getElementById('couponCodeField').value = couponCode;
         
        $('#couponModal').modal('hide');
    }

     const placeOrderBtn = document.getElementById('placeOrderBtn');
placeOrderBtn.addEventListener('click', async function() {
    let addressData;
    const differentAddress = document.getElementById('differentaddress').checked;

    if (differentAddress) {
        addressData = {
            addressType: document.getElementById('addressType').value,
            addressLine1: document.getElementById('addressLine1').value,
            addressLine2: document.getElementById('addressLine2').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            zipCode: document.getElementById('zipCode').value
        };
    } else {
        const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
        if (!selectedAddress) {
            alert('Please select an address');
            return;
        }
        addressData = { addressId: selectedAddress.value };
    }

    const selectedPayment = document.querySelector('input[name="payment_option"]:checked');
    if (!selectedPayment) {
        alert('Please select a payment method');
        return;
    }

    const total=document.getElementById("total").innerHTML
    if (selectedPayment.value === 'Razorpay') {
            
        const response = await fetch('/place-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                address: addressData,
                paymentOption: 'Razorpay',
                newAddress: differentAddress,
                total:total
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log(data)
            const options = {
                "key": "rzp_test_xaGkIpXmOWb28y",
                "amount": data.amount,
                "currency": "INR",
                "name": "lapHQ",
                "description": "Test Transaction",
                "order_id": data.razorpayOrderId, 
                "handler": function (response) {
                    fetch('/verify-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_signature: response.razorpay_signature,
                            orderId: data.orderId,
                            couponId: appliedCouponId,
                            couponCode: appliedCouponCode,
                            discount: appliedDiscount
                        })
                    }).then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Payment Successful', 'Your order has been placed successfully!', 'success')
                            .then(() => {
                                window.location.href = "/order-confirmation?orderId=" + data.orderId;
                            });
                        } else {
                            Swal.fire('Payment Failed', data.message, 'error');
                        }
                    });
                },
                "prefill": {
                    "name": "<%= userData.name %>",
                    "email": "<%= userData.email %>",
                    "contact": "<%= userData.phone %>"
                },
                "theme": {
                    "color": "#F37254"
                }
            };
            const rzp1 = new Razorpay(options);
            rzp1.open();
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } else if(selectedPayment.value === 'Wallet'){
        const response = await fetch('/place-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            address: addressData,
            paymentOption: 'Wallet',
            newAddress: differentAddress,
            total: total,
            couponId: appliedCouponId,
            couponCode: appliedCouponCode,
            discount: appliedDiscount
        })
    });

    const result = await response.json();
    if (result.success) {
        Swal.fire('Order Placed', 'Your order has been placed successfully using your wallet balance', 'success')
        .then(() => {
            window.location.href = "/order-confirmation?orderId=" + result.orderId;
        });
    } else {
        Swal.fire('Error', result.message, 'error');
    }
    }else{
        const orderData = {
            address: addressData,
            paymentOption: selectedPayment.value,
            newAddress: differentAddress,
            total:total,
            couponId:appliedCouponId,
            couponCode: appliedCouponCode,
            discount: appliedDiscount
        };

        const response = await fetch('/place-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
        });

        const result = await response.json();
        if (result.success) {
            const productDetailsHtml = result.products.map(product => 
                    `<p>${product.name} - Qty: ${product.quantity} - Price: $${product.price.toFixed(2)}</p>`
                ).join('');

            await Swal.fire({
                icon: 'success',
                title: 'Order Placed Successfully!',
                html: `
                    <h3>Order ID: ${result.orderId}</h3>
                    <h4>Products:</h4>
                    ${productDetailsHtml}
                    <h4>Total: $${result.total.toFixed(2)}</h4>
                `,
                confirmButtonText: 'View Order Details'
            });
            window.location.href = '/order-confirmation?orderId=' + result.orderId;
        } else {
            alert('Error placing order: ' + result.message);
        }
    }
});

</script>

<%- include("../partials/homepage/userFooter") %>